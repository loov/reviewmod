{{- define "function-context" -}}
{{- if .Functions}}

## Functions (mutually recursive group)
{{range .Functions}}
### {{.Name}}

```go
{{.Body}}
```
{{end -}}
{{- else}}

## Function: {{.Name}}
Package: {{.Package}}

```go
{{.Body}}
```
{{- end}}
{{- end}}

{{- define "summary-context" -}}
{{- if .Summary}}

## Function Summary
Purpose: {{.Summary.Purpose}}
Behavior: {{.Summary.Behavior}}
{{- if .Summary.Invariants}}
Invariants:
{{- range .Summary.Invariants}}
- {{.}}
{{- end}}
{{- end}}
{{- if .Summary.Security}}
Security Notes:
{{- range .Summary.Security}}
- {{.}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

{{- define "callees-context" -}}
{{- if .Callees}}

## Called Functions
{{- range .Callees}}

### {{.Name}}
Purpose: {{.Purpose}}
Behavior: {{.Behavior}}
{{- if .Invariants}}
Invariants:
{{- range .Invariants}}
- {{.}}
{{- end}}
{{- end}}
{{- if .Security}}
Security:
{{- range .Security}}
- {{.}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

{{- define "external-funcs-context" -}}
{{- if .ExternalFuncs}}

## External Functions Used
{{- range .ExternalFuncs}}

### {{.Package}}.{{.Name}}
Signature: {{.Signature}}
{{- if .Godoc}}
{{.Godoc}}
{{- end}}
{{- end}}
{{- end}}
{{- end}}

{{- define "issues-format"}}

Respond with JSON. The "code" field must contain the exact line of code where the issue occurs, copied verbatim from the code block above.

Example:
{"issues": [{"function": "ParseConfig", "code": "	query := \"SELECT * FROM users WHERE id=\" + id", "severity": "critical", "message": "SQL injection via string concatenation", "suggestion": "Use parameterized query"}]}

If no issues found, return {"issues": []}.
{{- end}}
